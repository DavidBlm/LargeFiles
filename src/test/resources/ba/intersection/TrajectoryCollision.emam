package ba.intersection;
import ba.util.TrajectoryToLines;
import ba.util.LineIntersection;
import ba.util.DualSetCompareMatrix;

//TODO: m1 = m -1, m2 = m1(m1+1)/2
component TrajectoryCollision<N1 m = 5, N1 m1 = 4, N1 m2 = 10>{
    ports in Q^{3,m} trajectoryA,
          in Q^{3,m} trajectoryB,
          in Q cutoffTime,
          out B collision;

    instance TrajectoryToLines trajectoryToLinesA;
    instance TrajectoryToLines trajectoryToLinesB;
    instance DualSetCompareMatrix<4,1,m1,m2> dualSetCompare;
    instance LineIntersection lineIntersection[m2];
    instance FirstLineIntersection firstLineIntersection;
    instance TimeCutoffFilter(2.0) timeCutoffFilter;

    connect trajectoryA -> trajectoryToLinesA.trajectoryIn;
    connect trajectoryB -> trajectoryToLinesB.trajectoryIn;

    connect lineIntersection[:].intersects -> firstLineIntersection.collisionIn[:];
    connect lineIntersection[:].point -> firstLineIntersection.pointsIn[:];

    connect firstLineIntersection.collisionOut -> timeCutoffFilter.collisionIn;
    connect firstLineIntersection.linexA -> timeCutoffFilter.IndexInA;
    connect firstLineIntersection.linexB -> timeCutoffFilter.IndexInB;
    connect firstLineIntersection.pos -> timeCutoffFilter.colPosIn;
    connect trajectoryA -> timeCutoffFilter.trajectoryInA;
    connect trajectoryB -> timeCutoffFilter.trajectoryInB;
    connect cutoffTime -> timeCutoffFilter.timeCutoff;
    connect timeCutoffFilter.collisionOut -> collision;

    connect trajectoryToLinesA.lineOut[:] -> dualSetCompare.setInA[:];
    connect trajectoryToLinesB.lineOut[:] -> dualSetCompare.setInB[:];

    connect dualSetCompare.outA[:] -> lineIntersection[:].lineA;
    connect dualSetCompare.outB[:] -> lineIntersection[:].lineB;
}